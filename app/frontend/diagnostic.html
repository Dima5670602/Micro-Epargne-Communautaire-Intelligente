<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnostic - Micro-√âpargne</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <h1> Diagnostic Syst√®me</h1>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Test API</h5>
          </div>
          <div class="card-body">
            <button class="btn btn-primary" onclick="testAPI()">Tester l'API</button>
            <div id="apiResult" class="mt-3"></div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Test Base de Donn√©es</h5>
          </div>
          <div class="card-body">
            <button class="btn btn-warning" onclick="testDatabase()">Tester la BDD</button>
            <div id="dbResult" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        <h5>Cr√©er un utilisateur de test directement</h5>
      </div>
      <div class="card-body">
        <button class="btn btn-success" onclick="createTestUser()">Cr√©er utilisateur test en BDD</button>
        <div id="createUserResult" class="mt-3"></div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        <h5>Logs de d√©bogage</h5>
      </div>
      <div class="card-body">
        <pre id="debugLogs" style="height: 200px; overflow-y: scroll; background: #f8f9fa; padding: 10px;"></pre>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';

    function log(message) {
      const logs = document.getElementById('debugLogs');
      logs.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
      logs.scrollTop = logs.scrollHeight;
    }

    async function testAPI() {
      log('Test de l\'API en cours...');
      const result = document.getElementById('apiResult');
      
      try {
        const response = await fetch(API_URL + '/auth/test');
        const data = await response.json();
        
        if (response.ok) {
          result.innerHTML = `<div class="alert alert-success"> API fonctionnelle: ${data.message || 'OK'}</div>`;
          log(' API fonctionnelle');
        } else {
          result.innerHTML = `<div class="alert alert-warning"> API accessible mais erreur: ${data.message}</div>`;
          log(' API accessible mais erreur');
        }
      } catch (error) {
        result.innerHTML = `<div class="alert alert-danger"> API inaccessible: ${error.message}</div>`;
        log(' API inaccessible: ' + error.message);
      }
    }

    async function testDatabase() {
      log(' Test de la base de donn√©es en cours...');
      const result = document.getElementById('dbResult');
      
      try {
        // Essayer de r√©cup√©rer la liste des utilisateurs
        const response = await fetch(API_URL + '/users');
        const data = await response.json();
        
        if (response.ok) {
          result.innerHTML = `<div class="alert alert-success">
             Base de donn√©es accessible<br>
             ${data.length} utilisateur(s) trouv√©(s)
          </div>`;
          log(` BDD accessible - ${data.length} utilisateurs`);
          console.log('Utilisateurs en BDD:', data);
        } else {
          result.innerHTML = `<div class="alert alert-warning"> BDD accessible mais erreur</div>`;
          log(' BDD accessible mais erreur');
        }
      } catch (error) {
        result.innerHTML = `<div class="alert alert-danger"> Impossible d'acc√©der √† la BDD: ${error.message}</div>`;
        log(' Impossible d\'acc√©der √† la BDD: ' + error.message);
      }
    }

    async function createTestUser() {
      log('üë§ Cr√©ation d\'un utilisateur test en BDD...');
      const result = document.getElementById('createUserResult');
      
      const testUser = {
        prenom: 'Test',
        nom: 'User',
        email: 'test@diagnostic.com',
        telephone: '+226 00 00 00 00',
        password: 'test123',
        role: 'organisateur',
        is_premium: false
      };

      try {
        const response = await fetch(API_URL + '/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(testUser)
        });

        const data = await response.json();

        if (response.ok) {
          result.innerHTML = `<div class="alert alert-success">
             Utilisateur cr√©√© en BDD avec succ√®s!<br>
             Email: ${testUser.email}<br>
             Mot de passe: ${testUser.password}<br>
             ID: ${data.user.id}
          </div>`;
          log(` Utilisateur cr√©√© en BDD - ID: ${data.user.id}`);
        } else {
          result.innerHTML = `<div class="alert alert-danger">
             Erreur lors de la cr√©ation: ${data.message || 'Erreur inconnue'}
          </div>`;
          log(` Erreur cr√©ation utilisateur: ${data.message}`);
        }
      } catch (error) {
        result.innerHTML = `<div class="alert alert-danger"> Erreur r√©seau: ${error.message}</div>`;
        log(' Erreur r√©seau lors de la cr√©ation: ' + error.message);
      }
    }

    // Tests automatiques au chargement
    window.addEventListener('DOMContentLoaded', function() {
      log(' D√©marrage du diagnostic...');
      setTimeout(testAPI, 1000);
      setTimeout(testDatabase, 2000);
    });
  </script>
</body>
</html>